## nginx

# ==================== 前端网站配置（TX Fabric） ====================

# 80 端口服务：HTTP 转 HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name riohome.top www.riohome.top;

    # 将所有流量重定向到 HTTPS
    return 301 https://$host$request_uri;
}

# 443 端口服务：前端网站 HTTPS 流量并反向代理到 Next.js
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name riohome.top www.riohome.top;

    # ======================= SSL 证书配置开始 =======================
    # 指定证书文件，请替换为您实际的证书路径
    ssl_certificate /etc/ssl/cert/riohome.top.pem;
    # 指定私钥文件，请替换为您实际的私钥路径
    ssl_certificate_key /etc/ssl/cert/riohome.top.key;
    # 配置 SSL 会话缓存，提高性能
    ssl_session_cache shared:SSL:10m;
    # 设置 SSL 会话超时时间
    ssl_session_timeout 10m;
    # TLS 协议类型和加密套件
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    # 指定允许的 TLS 协议版本
    ssl_protocols TLSv1.2 TLSv1.3;
    # 优先使用服务端指定的加密套件
    ssl_prefer_server_ciphers on;
    # ======================= SSL 证书配置结束 =======================

    # 安全头配置
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 日志配置（可选）
    access_log /var/log/nginx/frontend_access.log;
    error_log /var/log/nginx/frontend_error.log;

    # Next.js 静态资源缓存配置（_next/static 文件夹）
    location /_next/static {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # 静态资源缓存 1 年
        expires 365d;
        add_header Cache-Control "public, immutable";
    }

    # 图片等静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:3000;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    # Next.js 主应用代理
    location / {
        # 将请求代理到 3000 端口运行的 Next.js 应用
        proxy_pass http://127.0.0.1:3000;
        
        # HTTP/1.1 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # 传递必要的头信息
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 缓冲配置
        proxy_cache_bypass $http_upgrade;
        proxy_buffering off;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# ==================== API 服务配置 ====================

# 80 端口服务：HTTP 转 HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name api.riohome.top;

    # 将所有流量重定向到 HTTPS
    return 301 https://\$host\$request_uri;
}

# 443 端口服务：处理 HTTPS 流量并反向代理到 FastAPI
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name api.riohome.top;

    # --- Certbot 管理的 SSL 配置 ---
    # ssl_certificate /etc/letsencrypt/live/api.riohome.top/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/api.riohome.top/privkey.pem;
    # include /etc/letsencrypt/options-ssl-nginx.conf;
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    # ---------------------------------
    # ======================= 证书配置开始 =======================
    # 指定证书文件（中间证书可以拼接至该pem文件中），请将 /etc/ssl/cert/ssl.pem 替换为您实际使用的证书文件的绝对路径
    ssl_certificate /etc/ssl/cert/api.riohome.top.pem;
    # 指定私钥文档，请将 /etc/ssl/cert/ssl.key 替换为您实际使用的私钥文件的绝对路径
    ssl_certificate_key /etc/ssl/cert/api.riohome.top.key;
    # 配置 SSL 会话缓存，提高性能
    ssl_session_cache shared:SSL:1m;
    # 设置 SSL 会话超时时间
    ssl_session_timeout 5m;
    # 自定义设置使用的TLS协议的类型以及加密套件（以下为配置示例，请您自行评估是否需要配置）
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    # 指定允许的 TLS 协议版本，TLS协议版本越高，HTTPS通信的安全性越高，但是相较于低版本TLS协议，高版本TLS协议对浏览器的兼容性较差
    ssl_protocols TLSv1.2 TLSv1.3;
    # 优先使用服务端指定的加密套件
    ssl_prefer_server_ciphers on;
    # ======================= 证书配置结束 =======================


    location / {
        # 将请求代理到在 8000 端口运行的 FastAPI 应用
        proxy_pass http://127.0.0.1:8000;

        # 为 WebSocket 提供支持
        proxy_http_version 1.1; 
        # 关键：改为 HTTP/1.1 以支持 Upgrade（WebSocket/SSE）
        proxy_set_header Upgrade $http_upgrade; 
        # 传递升级头以支持 WebSocket/SSE
        proxy_set_header Connection "upgrade"; 
        # 设置连接升级头

        proxy_set_header Host $host; 
        # 保留原始 Host 供后端识别域名
        proxy_set_header X-Real-IP $remote_addr; 
        # 传递真实客户端 IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
        # 传递代理链路 IP
        proxy_set_header X-Forwarded-Proto $scheme; 
        # 传递原始协议（http/https）

        proxy_buffering off; 
        # 关闭缓冲以支持流式响应与实时输出
        proxy_read_timeout 600s; 
        # 延长读取超时避免长任务中断
        proxy_send_timeout 600s; 
        # 延长发送超时支持大响应或慢客户端
    }
}

# ==================== 部署说明 ====================

## 1. 准备工作

### 域名配置
- 主域名：riohome.top → 服务器IP
- www域名：www.riohome.top → 服务器IP
- API域名：api.riohome.top → 服务器IP

### SSL证书准备
需要为主域名申请SSL证书，放置在：
- 证书文件：/etc/ssl/cert/riohome.top.pem
- 私钥文件：/etc/ssl/cert/riohome.top.key

## 2. 部署步骤

### 步骤1：复制nginx配置
```bash
# 创建前端网站配置文件
sudo nano /etc/nginx/sites-available/frontend

# 将上面的前端配置粘贴进去，然后创建软链接
sudo ln -s /etc/nginx/sites-available/frontend /etc/nginx/sites-enabled/

# API配置同理
sudo nano /etc/nginx/sites-available/api
sudo ln -s /etc/nginx/sites-available/api /etc/nginx/sites-enabled/
```

### 步骤2：测试nginx配置
```bash
# 测试配置文件语法
sudo nginx -t

# 如果显示 "syntax is ok" 和 "test is successful" 则继续
```

### 步骤3：启动Next.js应用
```bash
# 进入项目目录
cd /path/to/tx-fabric

# 安装依赖
npm install

# 构建生产版本
npm run build

# 使用 PM2 启动应用（推荐）
pm2 start npm --name "tx-fabric" -- start

# 或使用 nohup 后台运行
nohup npm start > /var/log/nextjs.log 2>&1 &
```

### 步骤4：重启nginx
```bash
# 重新加载nginx配置
sudo nginx -s reload

# 或重启nginx服务
sudo systemctl restart nginx
```

## 3. PM2 进程管理（推荐）

### 安装PM2
```bash
npm install -g pm2
```

### PM2 常用命令
```bash
# 启动应用
pm2 start npm --name "tx-fabric" -- start

# 查看运行状态
pm2 status

# 查看日志
pm2 logs tx-fabric

# 重启应用
pm2 restart tx-fabric

# 停止应用
pm2 stop tx-fabric

# 设置开机自启
pm2 startup
pm2 save
```

## 4. 验证部署

### 检查服务运行状态
```bash
# 检查Next.js是否在3000端口运行
netstat -tuln | grep 3000

# 检查FastAPI是否在8000端口运行
netstat -tuln | grep 8000

# 查看nginx状态
sudo systemctl status nginx
```

### 访问测试
- 前端网站：https://riohome.top
- API接口：https://api.riohome.top

## 5. 故障排查

### 502 Bad Gateway
- 检查Next.js应用是否正常运行
- 确认3000端口是否被占用
- 查看nginx错误日志：`sudo tail -f /var/log/nginx/frontend_error.log`

### SSL证书问题
- 确认证书文件路径正确
- 检查证书是否过期
- 验证证书权限：`ls -l /etc/ssl/cert/`

### 性能优化建议
- 启用gzip压缩
- 配置nginx缓存
- 使用CDN加速静态资源
- 启用HTTP/2（已在配置中启用）

## 6. 环境变量配置

Next.js应用需要配置生产环境变量：
```bash
# 在服务器上创建 .env.production
cd /path/to/tx-fabric
nano .env.production
```

添加必要的环境变量：
```env
# 生产环境配置
NODE_ENV=production
NEXT_PUBLIC_SITE_URL=https://riohome.top
NEXT_PUBLIC_API_URL=https://api.riohome.top

# ICP备案信息
NEXT_PUBLIC_ICP_NUMBER=粤ICP备2025493637号
```