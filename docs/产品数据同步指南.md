# 产品数据同步指南

## 📋 概述

本指南说明如何将 `产品数据表.csv` 中的数据同步到网站的 `data/products.json` 文件。

## 🎯 使用场景

- **修改价格**：在 CSV 中更新产品价格后同步到网站
- **新增产品**：在 CSV 中添加新产品后同步到网站
- **更新信息**：修改产品的幅宽、克重、成分等信息

## 📝 CSV 文件格式

### 文件位置
`产品数据表.csv`（位于项目根目录）

### 列格式说明

| 列名 | 说明 | 示例 | 必填 |
|------|------|------|------|
| 编号 | 产品编号 | 801# | ✅ |
| 品名名称 | 产品名称 | 涤天丝（曲天丝） | ✅ |
| 幅宽(cm) | 布料宽度 | 150 | ✅ |
| 克重(g) | 每平方米克重 | 55 | ❌ |
| 成份 | 面料成分 | 90%天丝、10%涤 | ✅ |
| 白色(元) | 白色成本价 | 日/夜4.1 或 4.1 | ❌ |
| 彩色(元) | 彩色成本价 | 彩4.4 或 4.4 | ❌ |
| 空差 | 空差值 | 91 | ✅ |
| 版布价 | 版布成本价 | 7 | ❌ |

### CSV 示例

```csv
编号,品名名称,幅宽(cm),克重(g),成份,白色(元),彩色(元),空差,版布价
801#,涤天丝（曲天丝）,150,55,90%天丝、10%涤,日/夜4.1,彩4.4,91,7
802#,天丝仙女条,150,65,75%天丝、25%锦纶,4,4.2,91,6
```

## 🚀 同步操作步骤

### 第一步：编辑 CSV 文件

1. 打开 `产品数据表.csv`
2. 修改价格、新增产品或更新产品信息
3. 保存文件

**注意事项：**
- 编号格式必须是 `xxx#`（如：801#）
- 价格支持"日/夜4.1"或直接写"4.1"两种格式
- 成分格式：`百分比%材料、百分比%材料`（如：90%天丝、10%涤）
- 多个成分用中文顿号`、`或逗号`,`分隔

### 第二步：预览变更

运行预览命令查看将要进行的变更：

```bash
node scripts/sync-products.js --dry-run
```

**输出示例：**
```
📊 开始同步产品数据...

📖 读取 CSV 文件: E:\tx-fabric\产品数据表.csv
✅ 读取到 53 条产品数据

📖 读取现有产品数据: E:\tx-fabric\data\products.json
✅ 现有 53 个产品

📋 变更摘要：
  ✅ 新增产品: 2 个
  🔄 更新产品: 5 个
  ⏸️  无变化: 46 个

➕ 新增产品：
  833# - 新品面料A
  834# - 新品面料B

🔄 更新产品：
  801# - 涤天丝（曲天丝）
    白色价: ¥4.1 → ¥4.3
  802# - 天丝仙女条
    彩色价: ¥4.2 → ¥4.5
```

### 第三步：执行同步

确认变更无误后，执行实际同步：

```bash
node scripts/sync-products.js
```

**同步过程：**
1. 自动备份原 `products.json` 为 `products.json.backup`
2. 更新产品数据
3. 显示同步结果和统计信息

## 📊 同步规则

### 1. 产品编号匹配

- 通过产品编号（如 801#）匹配 CSV 和 JSON 中的产品
- 如果编号已存在，更新该产品信息
- 如果编号不存在，创建新产品

### 2. 自动分类

根据产品编号自动归类：

| 编号范围 | 分类 | category ID |
|---------|------|-------------|
| 801-899 | 天丝系列 | tencel |
| 601-699 | 绣花底布系列 | embroidery-base |
| 901-999 | 棉布系列 | cotton |

### 3. 保留字段

以下字段不会被 CSV 覆盖，保留原有值：

- `id`：产品唯一ID
- `slug`：URL标识符
- `category`：分类（首次创建后保留）
- `description`：详细描述
- `images`：产品图片数组
- `inStock`：库存状态
- `featured`：是否精选
- `tags`：标签数组

### 4. 更新字段

以下字段会从 CSV 同步更新：

- `productNo`：产品编号
- `name`：产品名称
- `whitePrice`：白色成本价
- `colorPrice`：彩色成本价
- `samplePrice`：版布成本价
- `hc`：空差
- `width`：幅宽
- `weight`：克重
- `content`：面料成分

## 💡 使用技巧

### 1. 批量更新价格

在 Excel 中打开 CSV：
1. 选中价格列
2. 使用公式批量调整（如：`=原价格*1.1` 提价10%）
3. 保存后运行同步脚本

### 2. 快速新增产品

复制相似产品的行：
1. 修改编号（确保不重复）
2. 修改产品名称
3. 调整价格和参数
4. 运行同步脚本

### 3. 价格验证

使用 `--dry-run` 预览模式：
- 可以多次运行，不会修改数据
- 确认价格变更无误后再执行实际同步

## ⚠️ 注意事项

### 1. 数据备份

- 同步时会自动备份原 `products.json` 为 `.backup` 文件
- 如需回滚，删除当前文件并重命名备份文件

### 2. 产品图片

- 新增产品时，脚本会自动设置默认图片路径：`/images/products/编号_1.jpg`
- 需要手动上传对应的产品图片到 `public/images/products/` 目录
- 参考：[图片管理指南](./图片管理指南.md)

### 3. CSV 编码

- 建议使用 UTF-8 编码保存 CSV 文件
- Excel 保存时选择"UTF-8 CSV"格式
- 避免使用特殊字符导致乱码

### 4. 价格格式

支持的价格格式：
- ✅ `4.1`
- ✅ `日/夜4.1`
- ✅ `彩4.4`
- ❌ `4.1元` （不支持，需去掉"元"字）
- ❌ `4,1` （不支持，小数点必须用"."）

## 🔧 故障排查

### 问题1：编码错误或乱码

**原因**：CSV 文件编码不是 UTF-8

**解决方法**：
1. 用记事本打开 CSV 文件
2. 另存为，选择编码为 "UTF-8"
3. 重新运行同步脚本

### 问题2：价格解析失败

**原因**：价格格式不符合要求

**解决方法**：
1. 检查价格列是否包含非数字字符（除了允许的前缀）
2. 确保小数点使用 `.` 而不是 `,`
3. 移除货币符号（¥、元等）

### 问题3：成分解析错误

**原因**：成分格式不正确

**解决方法**：
成分必须是：`百分比%材料、百分比%材料`
- ✅ 正确：`90%天丝、10%涤`
- ❌ 错误：`天丝90%、涤10%`
- ❌ 错误：`90%天丝 10%涤`（缺少分隔符）

### 问题4：新产品没有显示

**原因**：可能缺少产品图片

**解决方法**：
1. 检查 `public/images/products/` 目录
2. 确保存在对应的图片文件（如：`833_1.jpg`）
3. 如暂无图片，可以先使用占位图

## 📚 相关文档

- [图片管理指南](./图片管理指南.md)
- [价格计算说明](./价格计算说明.md)
- [前端优化](./前端优化.md)

## 🎓 完整示例

### 场景：新增一个产品并调整两个产品的价格

#### 1. 编辑 CSV

在 `产品数据表.csv` 末尾添加新产品，并修改现有产品价格：

```csv
编号,品名名称,幅宽(cm),克重(g),成份,白色(元),彩色(元),空差,版布价
801#,涤天丝（曲天丝）,150,55,90%天丝、10%涤,4.3,4.6,91,7
802#,天丝仙女条,150,65,75%天丝、25%锦纶,4.2,4.5,91,6
...
833#,新品天丝,150,60,100%天丝,5.0,5.2,91,8
```

#### 2. 预览变更

```bash
node scripts/sync-products.js --dry-run
```

查看输出，确认：
- 801# 和 802# 的价格变更正确
- 833# 新产品信息正确

#### 3. 执行同步

```bash
node scripts/sync-products.js
```

#### 4. 添加产品图片

上传图片到 `public/images/products/833_1.jpg`

#### 5. 验证

访问网站查看：
- 最新报价页面是否显示新产品
- 801# 和 802# 的价格是否更新

## 📞 技术支持

如遇问题，请检查：
1. Node.js 版本 >= 14
2. CSV 文件格式是否正确
3. 备份文件是否存在
4. 控制台错误信息

---

**最后更新**：2025-11-13

