# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Node.js (推荐使用NodeSource仓库)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装PM2进程管理器
sudo npm install -g pm2

# 确保nginx已安装
sudo apt install nginx -y



# 2. 删除当前项目
cd /var/www

# 3. 重新克隆项目（如果有Git仓库）
git clone /var/repo/tx_fabric.git tx_fabric


# 5. 进入项目目录
cd /var/www/tx_fabric

# 6. 安装依赖
npm install

# 发现node版太低
# 下载并安装 NVM
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
# 重新加载 shell 配置
source ~/.bashrc
# 或者如果使用 zsh
source ~/.zshrc
、
# 验证 NVM 安装
nvm --version
# 安装最新的 Node.js v20.x 版本
nvm install 20
# 设置 Node.js v20 为默认版本
nvm alias default 20
# 检查当前使用的 Node.js 版本
node -v
# 检查 npm 版本
npm -v


# 7. 修复安全漏洞
npm audit fix

# 8. 构建项目
npm run build

# 编辑PM2配置文件
cd /var/www/tx-fabric
nano ecosystem.config.js

module.exports = {
  apps: [{
    name: 'tx-fabric',
    script: 'npm',
    args: 'start',
    cwd: '/var/www/tx-fabric',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 9090  // 修改为9090端口
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};

sudo nano /etc/nginx/sites-available/tx-fabric
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名或IP

    location / {
        proxy_pass http://localhost:9090;  # 修改为9090端口
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 静态资源缓存优化
    location /_next/static {
        proxy_pass http://localhost:9090;  # 修改为9090端口
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}

# 替换为tx-fabric
sudo ln -s /etc/nginx/sites-available/tx-fabric /etc/nginx/sites-enabled/
# 测试Nginx配置
sudo nginx -t
# 重启Nginx
sudo systemctl restart nginx
# 9. 启动应用
pm2 start ecosystem.config.js
pm2 save


# 7. 如果构建成功，重启应用
pm2 restart tx-fabric
